<div class="tareas-container">
  <!-- Cabecera -->
  <div class="page-header">
    <div class="header-actions">
      <h1>{{ getHeaderTitle() }}</h1>
      <button
        *ngIf="puedeCrearTarea()"
        (click)="crearTarea()"
        class="btn btn-primary">
        <span>➕ Nueva Tarea</span>
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-container">
    <div class="search-form">
      <div class="form-group">
        <label for="nombreFilter">Buscar por nombre</label>
        <input
          type="text"
          id="nombreFilter"
          [(ngModel)]="nombreFilter"
          class="form-control"
          placeholder="Nombre de la tarea...">
      </div>

      <div class="form-group" *ngIf="cursos.length > 0">
        <label for="cursoFilter">Filtrar por curso</label>
        <select
          id="cursoFilter"
          [(ngModel)]="cursoFilter"
          class="form-control">
          <option [ngValue]="null">Todos los cursos</option>
          <option *ngFor="let curso of cursos" [ngValue]="curso.id">
            {{ curso.nombre }} - {{ curso.nivel || 'Sin nivel' }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="estadoFilter">Estado de las tareas</label>
        <select
          id="estadoFilter"
          [(ngModel)]="estadoFilter"
          class="form-control">
          <option value="todas">Todas</option>
          <option value="activas">Activas</option>
          <option value="pendientes">Pendientes</option>
          <option value="vencidas">Vencidas</option>
        </select>
      </div>

      <div class="form-buttons">
        <button (click)="search()" class="btn btn-primary">Filtrar</button>
        <button (click)="resetFilters()" class="btn btn-secondary">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando tareas...</p>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Información específica para alumnos -->
  <div *ngIf="esAlumno() && !loading && !error" class="info-alumno">
    <div class="info-card">
      <h3>📚 Información para ti</h3>
      <p>Aquí puedes ver todas las tareas que tienes asignadas. Incluye tareas de todos tus cursos y tareas específicas asignadas solo a ti.</p>
      <div class="estadisticas">
        <div class="stat">
          <span class="number">{{ tareas.length }}</span>
          <span class="label">Total de tareas</span>
        </div>
        <div class="stat">
          <span class="number">{{ getTareasActivas() }}</span>
          <span class="label">Tareas activas</span>
        </div>
        <div class="stat">
          <span class="number">{{ getTareasVencidas() }}</span>
          <span class="label">Tareas vencidas</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de tareas -->
  <div *ngIf="!loading && !error">
    <div *ngIf="tareas.length === 0" class="empty-state">
      <p>{{ getEmptyMessage() }}</p>
      <button
        *ngIf="puedeCrearTarea()"
        (click)="crearTarea()"
        class="btn btn-primary">
        Crear tu primera tarea
      </button>
    </div>

    <div *ngIf="tareas.length > 0" class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Curso</th>
            <th *ngIf="!esAlumno()">Profesor</th>
            <th>Fecha Publicación</th>
            <th>Fecha Límite</th>
            <th>Estado</th>
            <th *ngIf="!esAlumno()">Entregas</th>
            <th>Documento</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tarea of getPaginatedTareas()"
              [class.tarea-vencida]="isTareaVencida(tarea)"
              [class.tarea-activa]="!isTareaVencida(tarea)">
            <td>{{ tarea.id }}</td>
            <td>
              <strong>{{ tarea.nombre }}</strong>
              <div *ngIf="tarea.descripcion" class="descripcion-preview">
                {{ tarea.descripcion.length > 50 ? (tarea.descripcion.substring(0, 50) + '...') : tarea.descripcion }}
              </div>
            </td>
            <td>
              <span class="badge badge-curso">{{ tarea.curso?.nombre || 'N/A' }}</span>
              <div *ngIf="tarea.curso?.nivel" class="nivel-curso">{{ tarea.curso?.nivel }}</div>
            </td>
            <td *ngIf="!esAlumno()">
              {{ tarea.profesor?.nombre }} {{ tarea.profesor?.apellido }}
            </td>
            <td>{{ formatFecha(tarea.fechaPublicacion) }}</td>
            <td>
              <span [style.color]="isTareaVencida(tarea) ? '#d32f2f' : '#333'">
                {{ formatFecha(tarea.fechaLimite) }}
                <span *ngIf="isTareaVencida(tarea)" class="badge badge-danger">VENCIDA</span>
              </span>
            </td>
            <td>
              <span
                class="badge estado-badge"
                [style.background-color]="getEstadoColor(tarea)"
                [style.color]="'white'">
                {{ getEstadoTarea(tarea) }}
              </span>
            </td>
            <td *ngIf="!esAlumno()">
              <div class="entregas-info">
                <span class="entregas-count">{{ tarea.totalEntregas || 0 }}</span>
                <span *ngIf="(tarea.entregasPendientes || 0) > 0" class="entregas-pendientes">
                  ({{ tarea.entregasPendientes }} pendientes)
                </span>
              </div>
            </td>
            <td>
              <div *ngIf="tieneDocumento(tarea)">
                <span class="badge badge-success">Disponible</span>
              </div>
              <span *ngIf="!tieneDocumento(tarea)" class="badge badge-secondary">Sin documento</span>
            </td>
            <td class="actions-cell">
              <!-- Ver detalles -->
              <button
                class="btn-icon btn-view"
                title="Ver detalles"
                (click)="verTarea(tarea.id!)">👁️</button>

              <!-- Hacer entrega (solo alumnos) -->
              <button
                *ngIf="puedeHacerEntrega(tarea)"
                class="btn-icon btn-entrega"
                [class.btn-entrega-vencida]="isTareaVencida(tarea)"
                [title]="isTareaVencida(tarea) ? 'Hacer entrega (FUERA DE PLAZO)' : 'Hacer entrega'"
                (click)="hacerEntrega(tarea.id!)">
                <span *ngIf="!isTareaVencida(tarea)">📤</span>
                <span *ngIf="isTareaVencida(tarea)">⚠️📤</span>
              </button>

              <!-- Ver entregas (solo profesores/admin) -->
              <button
                *ngIf="puedeVerEntregas(tarea)"
                class="btn-icon btn-entregas"
                title="Ver entregas"
                (click)="verEntregasTarea(tarea.id!)">📋</button>

              <!-- Editar -->
              <button
                *ngIf="puedeEditarTarea(tarea)"
                class="btn-icon btn-edit"
                title="Editar"
                (click)="editarTarea(tarea.id!)">✏️</button>

              <!-- Eliminar -->
              <button
                *ngIf="puedeEliminarTarea(tarea)"
                class="btn-icon btn-delete"
                title="Eliminar"
                (click)="eliminarTarea(tarea.id!)">🗑️</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginación -->
      <app-pagination
        *ngIf="page"
        [currentPage]="currentPage"
        [totalPages]="page.totalPages"
        [pageSize]="pageSize"
        [totalElements]="page.totalElements"
        (pageChange)="onPageChange($event)">
      </app-pagination>
    </div>
  </div>
</div>


