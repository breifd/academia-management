<div *ngIf="loading" style="display: flex; justify-content: center; align-items: center; height: 200px;">
  <div style="text-align: center;">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #1e88e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
    <p style="margin-top: 16px; color: #555;">Cargando...</p>
  </div>
</div>

<!-- Contenedor principal del formulario -->
<div class="alumno-form-container" *ngIf="!loading">
  <!-- Cabecera del formulario -->
  <div style="background-color: #1e88e5; color: white; padding: 18px 24px; position: relative;">
    <h2 style="margin: 0; font-size: 22px; font-weight: 500;">{{ getMode() }} Alumno</h2>
  </div>

  <!-- Cuerpo del formulario -->
  <div style="padding: 24px;">

    <!-- Mensajes de alerta -->
    <div *ngIf="error" style="background-color: #ffebee; color: #d32f2f; padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #d32f2f; display: flex; align-items: center;">
      <span style="margin-right: 10px; font-size: 18px;">‚ö†Ô∏è</span>
      <span [innerHTML]="error"></span>
    </div>

    <div *ngIf="successMessage" style="background-color: #e8f5e9; color: #2e7d32; padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #2e7d32; display: flex; align-items: center;">
      <span style="margin-right: 10px; font-size: 18px;">‚úÖ</span>
      <span>{{ successMessage }}</span>
    </div>

    <!-- üöÄ ACTUALIZADO: Estados autom√°ticos de validaci√≥n -->

    <!-- Validando username (mientras escribe) -->
    <div style="margin-bottom: 16px; margin-top: 8px;" *ngIf="verificandoUsername">
      <div style="background-color: #fff3e0; color: #f57c00; padding: 8px 12px; border-radius: 4px; display: flex; align-items: center; font-size: 14px;">
        <span style="margin-right: 6px;">‚è≥</span>
        <span>Verificando disponibilidad...</span>
      </div>
    </div>

    <!-- Username disponible -->
    <div style="margin-bottom: 16px; margin-top: 8px;" *ngIf="usernameValidated && !usernameExists && !verificandoUsername">
      <div style="background-color: #e8f5e9; color: #2e7d32; padding: 8px 12px; border-radius: 4px; display: flex; align-items: center; font-size: 14px;">
        <span style="margin-right: 6px;">‚úÖ</span>
        <span>Nombre de usuario disponible</span>
      </div>
    </div>

    <!-- Username no disponible -->
    <div style="margin-bottom: 16px; margin-top: 8px;" *ngIf="usernameValidated && usernameExists && !verificandoUsername">
      <div style="background-color: #ffebee; color: #d32f2f; padding: 8px 12px; border-radius: 4px; display: flex; align-items: center; font-size: 14px;">
        <span style="margin-right: 6px;">‚ùå</span>
        <span>Este nombre de usuario ya est√° en uso</span>
      </div>
    </div>

    <!-- Formulario principal -->
    <form (ngSubmit)="guardar()">
      <!-- Datos del alumno -->
      <div [formGroup]="alumnoForm">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
          <!-- Nombre -->
          <div style="margin-bottom: 16px;">
            <label for="nombre" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
              Nombre <span style="color: #e53935;">*</span>
            </label>
            <input
              type="text"
              id="nombre"
              formControlName="nombre"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"
              [ngStyle]="{'border-color': alumnoForm.get('nombre')?.invalid && alumnoForm.get('nombre')?.touched ? '#e53935' : '#ddd'}">
            <div *ngIf="alumnoForm.get('nombre')?.invalid && alumnoForm.get('nombre')?.touched" style="color: #e53935; font-size: 13px; margin-top: 5px;">
              El nombre es obligatorio
            </div>
          </div>

          <!-- Apellido -->
          <div style="margin-bottom: 16px;">
            <label for="apellido" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
              Apellido <span style="color: #e53935;">*</span>
            </label>
            <input
              type="text"
              id="apellido"
              formControlName="apellido"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"
              [ngStyle]="{'border-color': alumnoForm.get('apellido')?.invalid && alumnoForm.get('apellido')?.touched ? '#e53935' : '#ddd'}">
            <div *ngIf="alumnoForm.get('apellido')?.invalid && alumnoForm.get('apellido')?.touched" style="color: #e53935; font-size: 13px; margin-top: 5px;">
              El apellido es obligatorio
            </div>
          </div>

          <!-- Fecha de Nacimiento -->
          <div style="margin-bottom: 16px;">
            <label for="fechaNacimiento" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
              Fecha de Nacimiento
            </label>
            <input
              type="date"
              id="fechaNacimiento"
              formControlName="fechaNacimiento"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;">
          </div>

          <!-- Email -->
          <div style="margin-bottom: 16px;">
            <label for="email" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
              Email
            </label>
            <input
              type="email"
              id="email"
              formControlName="email"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"
              [ngStyle]="{'border-color': alumnoForm.get('email')?.invalid && alumnoForm.get('email')?.touched ? '#e53935' : '#ddd'}">
            <div *ngIf="alumnoForm.get('email')?.invalid && alumnoForm.get('email')?.touched" style="color: #e53935; font-size: 13px; margin-top: 5px;">
              Email inv√°lido
            </div>
          </div>

          <!-- Tel√©fono -->
          <div style="margin-bottom: 16px;">
            <label for="telefono" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
              Tel√©fono
            </label>
            <input
              type="tel"
              id="telefono"
              formControlName="telefono"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;">
          </div>

          <!-- Direcci√≥n (span 2 columnas) -->
          <div style="margin-bottom: 16px; grid-column: span 2;">
            <label for="direccion" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
              Direcci√≥n
            </label>
            <input
              type="text"
              id="direccion"
              formControlName="direccion"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;">
          </div>
        </div>
      </div>

      <!-- Secci√≥n de Usuario -->
      <div *ngIf="mode !== 'view'" style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 18px; font-weight: 500;">Datos de Usuario</h3>

          <!-- Informaci√≥n en lugar de toggle en modo crear -->
          <div *ngIf="!usuarioExistente && mode === 'crear'" style="background-color: #e3f2fd; color: #1976d2; padding: 8px 16px; border-radius: 6px; margin-left: 10px; font-size: 14px;">
            <span>‚ö†Ô∏è Se crear√° autom√°ticamente un usuario para el alumno</span>
          </div>

          <!-- Toggle en edit sin usuario -->
          <div *ngIf="!usuarioExistente && mode === 'edit'">
            <button
              type="button"
              (click)="toggleCrearUsuario()"
              style="padding: 8px 16px; background-color: #f5f5f5; color: #333; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
              {{ crearUsuario ? 'No crear usuario' : 'Crear usuario' }}
            </button>
          </div>

          <div *ngIf="usuarioExistente" style="background-color: #e8f5e9; color: #2e7d32; padding: 8px 16px; border-radius: 6px;">
            <span>Usuario asociado: {{ usuarioExistente.username }}</span>
          </div>
        </div>

        <!-- Formulario de usuario - Siempre visible en crear -->
        <div *ngIf="(crearUsuario && !usuarioExistente) || mode === 'crear'" style="margin-top: 16px;">
          <div [formGroup]="usuarioForm">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
              <!-- Nombre de usuario -->
              <div style="margin-bottom: 16px;">
                <label for="username" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                  Nombre de usuario <span style="color: #e53935;">*</span>
                  <span style="color: #666; font-weight: normal; font-size: 13px;">(Se valida autom√°ticamente)</span>
                </label>
                <input
                  type="text"
                  id="username"
                  formControlName="username"
                  placeholder="Escribe tu nombre de usuario..."
                  style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"
                  [ngStyle]="{'border-color': usuarioForm.get('username')?.invalid && usuarioForm.get('username')?.touched ? '#e53935' : (usernameValidated && !usernameExists ? '#4caf50' : '#ddd')}">
                <div *ngIf="usuarioForm.get('username')?.invalid && usuarioForm.get('username')?.touched" style="color: #e53935; font-size: 13px; margin-top: 5px;">
                  <span *ngIf="usuarioForm.get('username')?.errors?.['required']">El nombre de usuario es obligatorio</span>
                  <span *ngIf="usuarioForm.get('username')?.errors?.['minlength']">El nombre de usuario debe tener al menos 4 caracteres</span>
                  <span *ngIf="usuarioForm.get('username')?.errors?.['maxlength']">El nombre de usuario no puede tener m√°s de 50 caracteres</span>
                  <span *ngIf="usuarioForm.get('username')?.errors?.['usernameTaken']">Este nombre de usuario ya existe</span>
                </div>

                <!-- üöÄ OPCIONAL: Mantener bot√≥n manual por si se necesita -->
                <div style="margin-top: 10px;" *ngIf="usuarioForm.get('username')?.value && usuarioForm.get('username')?.value.length >= 4">
                  <button
                    type="button"
                    (click)="verificarUsername()"
                    [disabled]="verificandoUsername"
                    style="padding: 6px 12px; background-color: #f5f5f5; color: #333; border: none; border-radius: 4px; font-weight: 500; cursor: pointer; font-size: 13px;">
                    <span *ngIf="!verificandoUsername">Verificar manualmente</span>
                    <span *ngIf="verificandoUsername">Verificando...</span>
                  </button>
                </div>
              </div>

              <!-- Contrase√±a -->
              <div style="margin-bottom: 16px;">
                <label for="password" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                  Contrase√±a <span style="color: #e53935;">*</span>
                </label>
                <input
                  type="password"
                  id="password"
                  formControlName="password"
                  style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"
                  [ngStyle]="{'border-color': usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched ? '#e53935' : '#ddd'}">
                <div *ngIf="usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched" style="color: #e53935; font-size: 13px; margin-top: 5px;">
                  La contrase√±a es obligatoria y debe tener al menos 6 caracteres
                </div>
              </div>

              <!-- Confirmar Contrase√±a -->
              <div style="margin-bottom: 16px;">
                <label for="confirmarPassword" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                  Confirmar Contrase√±a <span style="color: #e53935;">*</span>
                </label>
                <input
                  type="password"
                  id="confirmarPassword"
                  formControlName="confirmarPassword"
                  style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;"
                  [ngStyle]="{'border-color': usuarioForm.hasError('passwordMismatch') && usuarioForm.get('confirmarPassword')?.touched ? '#e53935' : '#ddd'}">
                <div *ngIf="usuarioForm.hasError('passwordMismatch') && usuarioForm.get('confirmarPassword')?.touched" style="color: #e53935; font-size: 13px; margin-top: 5px;">
                  Las contrase√±as no coinciden
                </div>
              </div>

              <!-- Usar mismo nombre y apellido -->
              <div style="margin-bottom: 16px; display: flex; align-items: center; grid-column: span 2;">
                <input
                  type="checkbox"
                  id="usarMismoNombre"
                  formControlName="usarMismoNombre"
                  style="margin-right: 8px;">
                <label for="usarMismoNombre" style="font-weight: 500; color: #333;">
                  Usar los mismos nombre y apellido del alumno
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Opci√≥n de sincronizaci√≥n para usuarios existentes -->
        <div *ngIf="usuarioExistente && mode === 'edit'" style="margin-top: 16px;">
          <div [formGroup]="usuarioForm">
            <div style="margin-bottom: 16px; display: flex; align-items: center;">
              <input
                type="checkbox"
                id="usarMismoNombre"
                formControlName="usarMismoNombre"
                style="margin-right: 8px;">
              <label for="usarMismoNombre" style="font-weight: 500; color: #333;">
                Sincronizar nombre y apellido con el usuario
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee;">
        <!-- Bot√≥n Cancelar -->
        <button
          type="button"
          (click)="cancelar()"
          style="padding: 10px 20px; background-color: #f5f5f5; color: #333; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; min-width: 100px;">
          Cancelar
        </button>

        <!-- Bot√≥n Guardar - solo visible en modos editar o crear -->
        <button
          *ngIf="mode === 'edit' || mode === 'crear'"
          type="button"
          (click)="guardar()"
          [disabled]="loading"
          style="padding: 10px 20px; background-color: #1e88e5; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; min-width: 100px;">
          <span *ngIf="!loading">Guardar</span>
          <span *ngIf="loading">Guardando...</span>
        </button>
      </div>
    </form>
  </div>
</div>
